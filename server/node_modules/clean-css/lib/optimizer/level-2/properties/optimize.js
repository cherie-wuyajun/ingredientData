var mergeIntoShorthands = require('clean-css/lib/optimizer/level-2/properties/merge-into-shorthands');
var overrideProperties = require('clean-css/lib/optimizer/level-2/properties/override-properties');
var populateComponents = require('clean-css/lib/optimizer/level-2/properties/populate-components');

var restoreWithComponents = require('clean-css/lib/optimizer/level-2/restore-with-components');

var wrapForOptimizing = require('clean-css/lib/optimizer/wrap-for-optimizing').all;
var removeUnused = require('clean-css/lib/optimizer/remove-unused');
var restoreFromOptimizing = require('clean-css/lib/optimizer/restore-from-optimizing');

var OptimizationLevel = require('clean-css/lib/options/optimization-level').OptimizationLevel;

function optimizeProperties(properties, withOverriding, withMerging, context) {
  var levelOptions = context.options.level[OptimizationLevel.Two];
  var _properties = wrapForOptimizing(properties, false, levelOptions.skipProperties);
  var _property;
  var i, l;

  populateComponents(_properties, context.validator, context.warnings);

  for (i = 0, l = _properties.length; i < l; i++) {
    _property = _properties[i];
    if (_property.block) {
      optimizeProperties(_property.value[0][1], withOverriding, withMerging, context);
    }
  }

  if (withMerging && levelOptions.mergeIntoShorthands) {
    mergeIntoShorthands(_properties, context.validator);
  }

  if (withOverriding && levelOptions.overrideProperties) {
    overrideProperties(_properties, withMerging, context.options.compatibility, context.validator);
  }

  restoreFromOptimizing(_properties, restoreWithComponents);
  removeUnused(_properties);
}

module.exports = optimizeProperties;
